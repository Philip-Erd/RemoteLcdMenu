<html>

<head>
    <title>Lcd</title>
    <script src="https://cdn.jsdelivr.net/npm/char-lcd"></script>
    <script src="lcd-controller.js"></script>
</head>

<body>
    <h1>Lcd</h1>

    <label for="baudRate">baud rate:</label>
    <input type="number" id="baudRate" value="9600">
    <button id="button_open_port">open serial port</button>


    <div id="lcd"></div>
    <div id="buttons">
        <button id="button_left">Left</button>
        <button id="button_up">Up</button>
        <button id="button_down">Down</button>
        <button id="button_right">Right</button>
        <button id="button_select">Select</button>
        <button id="button_back">Back</button>
    </div>


    <script>



        let writer = null

        let lcd = new CharLCD({ at: 'lcd', rows: 2, cols: 16, rom: 'jp' });
        let lcd_controller = new LcdController(lcd)


        document.getElementById("button_open_port").onclick = () => {
            navigator.serial.requestPort().then(async (port) => {
                let baudRate = document.getElementById("baudRate").value
                await port.open({ baudRate: baudRate });
                const reader = port.readable.getReader();
                writer = port.writable.getWriter()




                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        // Allow the serial port to be closed later.
                        reader.releaseLock();
                        break;
                    }

                    value.forEach(data => {
                        lcd_controller.process(data)
                    });
                }

                console.log("done")

            });
        }



        document.getElementById("button_select").onclick = () => { writer ? writer.write(new Uint8Array([10])) : console.warn("writer not available") }
        document.getElementById("button_back").onclick = () => { writer ? writer.write(new Uint8Array([27])) : console.warn("writer not available") }
        document.getElementById("button_up").onclick = () => { writer ? writer.write(new Uint8Array([128])) : console.warn("writer not available") }
        document.getElementById("button_down").onclick = () => { writer ? writer.write(new Uint8Array([129])) : console.warn("writer not available") }
        document.getElementById("button_right").onclick = () => { writer ? writer.write(new Uint8Array([130])) : console.warn("writer not available") }
        document.getElementById("button_left").onclick = () => { writer ? writer.write(new Uint8Array([131])) : console.warn("writer not available") }






    </script>

</body>

</html>